<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>7 Ajax - DAW DOCS</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>7 Ajax | DAW DOCS</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="7 Ajax" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Apuntes del módulo de “Desarrollo web en entorno servidor”, de 2º curso del Ciclo Formativo de Grado Superior de “Desarrollo de Aplicaciones Web”, impartido en el IES Celia Viñas de Almería (España)" /> <meta property="og:description" content="Apuntes del módulo de “Desarrollo web en entorno servidor”, de 2º curso del Ciclo Formativo de Grado Superior de “Desarrollo de Aplicaciones Web”, impartido en el IES Celia Viñas de Almería (España)" /> <link rel="canonical" href="/ajax/" /> <meta property="og:url" content="/ajax/" /> <meta property="og:site_name" content="DAW DOCS" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="7 Ajax" /> <script type="application/ld+json"> {"@type":"WebPage","url":"/ajax/","headline":"7 Ajax","description":"Apuntes del módulo de “Desarrollo web en entorno servidor”, de 2º curso del Ciclo Formativo de Grado Superior de “Desarrollo de Aplicaciones Web”, impartido en el IES Celia Viñas de Almería (España)","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> DAW DOCS </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/" class="nav-list-link">Desarrollo Web en Entorno Servidor</a><ul class="nav-list "><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/cms/" class="nav-list-link">1 Sistemas gestores de contenido (CMS)</a><ul class="nav-list"><li class="nav-list-item "> <a href="/cms/algunas-cosas-que-debes-saber" class="nav-list-link">1.1 Algunas cosas que debes saber sobre los CMS</a> </li><li class="nav-list-item "> <a href="/cms/wordpress" class="nav-list-link">1.2 Wordpress</a> </li><li class="nav-list-item "> <a href="/cms/moodle" class="nav-list-link">1.3 Moodle</a> </li><li class="nav-list-item "> <a href="/cms/prestashop" class="nav-list-link">1.4 Prestashop</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/php/" class="nav-list-link">2 Introducción a PHP</a><ul class="nav-list"><li class="nav-list-item "> <a href="/php/programacion-cliente-servidor" class="nav-list-link">2.1 Programación cliente-servidor</a> </li><li class="nav-list-item "> <a href="/php/caja-de-herramientas" class="nav-list-link">2.2 Caja de herramientas</a> </li><li class="nav-list-item "> <a href="/php/sintaxis-de-php" class="nav-list-link">2.3 Sintaxis de PHP</a> </li><li class="nav-list-item "> <a href="/php/interaccion-con-php" class="nav-list-link">2.4 Interacción con la base de datos</a> </li><li class="nav-list-item "> <a href="/php/ejercicios-resueltos" class="nav-list-link">2.5 Ejercicios resueltos</a> </li></ul></li><li class="nav-list-item "><a href="/cookies-sesiones-seguridad/" class="nav-list-link">3 Cookies, sesiones y seguridad</a></li><li class="nav-list-item "><a href="/mvc/" class="nav-list-link">4 Arquitectura MVC</a></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/laravel/" class="nav-list-link">5 Laravel</a><ul class="nav-list"><li class="nav-list-item "> <a href="/laravel/1" class="nav-list-link">5.1 Frameworks PHP MVC</a> </li><li class="nav-list-item "> <a href="/laravel/2" class="nav-list-link">5.2 Características de Laravel</a> </li><li class="nav-list-item "> <a href="/laravel/3" class="nav-list-link">5.3 Instalación de Laravel</a> </li><li class="nav-list-item "> <a href="/laravel/4" class="nav-list-link">5.4 Arquitectura, convenciones y configuración de Laravel</a> </li><li class="nav-list-item "> <a href="/laravel/5" class="nav-list-link">5.5 Artisan</a> </li><li class="nav-list-item "> <a href="/laravel/6" class="nav-list-link">5.6 Primeros pasos con Laravel. Hola mundo</a> </li><li class="nav-list-item "> <a href="/laravel/7" class="nav-list-link">5.7 Enrutamiento</a> </li><li class="nav-list-item "> <a href="/laravel/8" class="nav-list-link">5.8 Vistas y plantillas. Blade</a> </li><li class="nav-list-item "> <a href="/laravel/9" class="nav-list-link">5.9 Controladores</a> </li><li class="nav-list-item "> <a href="/laravel/10" class="nav-list-link">5.10 Migraciones</a> </li><li class="nav-list-item "> <a href="/laravel/11" class="nav-list-link">5.11 Usando la BD con Eloquent</a> </li><li class="nav-list-item "> <a href="/laravel/12" class="nav-list-link">5.12 Usando la BD con QueryBuilder</a> </li><li class="nav-list-item "> <a href="/laravel/13" class="nav-list-link">5.13 Sesiones con Laravel</a> </li><li class="nav-list-item "> <a href="/laravel/14" class="nav-list-link">5.14 Helpers de Laravel</a> </li><li class="nav-list-item "> <a href="/laravel/15" class="nav-list-link">5.15 Flujo de trabajo típico con Laravel</a> </li><li class="nav-list-item "> <a href="/laravel/16" class="nav-list-link">5.16 Laravel y Vue.js</a> </li><li class="nav-list-item "> <a href="/laravel/17" class="nav-list-link">5.17 Aspectos avanzados de Laravel</a> </li></ul></li><li class="nav-list-item "><a href="/servicios-web/" class="nav-list-link">6 Servicios web</a></li><li class="nav-list-item active"><a href="/ajax/" class="nav-list-link active">7 Ajax</a></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/otras-tecnologias/" class="nav-list-link">8 Otras tecnologías</a><ul class="nav-list"><li class="nav-list-item "> <a href="/otros/cgi" class="nav-list-link">8.1 CGI</a> </li><li class="nav-list-item "> <a href="/otros/perl" class="nav-list-link">8.2 Perl</a> </li><li class="nav-list-item "> <a href="/otros/python" class="nav-list-link">8.3 Python</a> </li><li class="nav-list-item "> <a href="/otros/.net" class="nav-list-link">8.4 .NET</a> </li><li class="nav-list-item "> <a href="/otros/jsp" class="nav-list-link">8.5 JSP</a> </li><li class="nav-list-item "> <a href="/otros/ruby" class="nav-list-link">8.6 Ruby</a> </li><li class="nav-list-item "> <a href="/otros/nodejs" class="nav-list-link">8.7 NodeJS</a> </li><li class="nav-list-item "> <a href="/otros/mas-tecnologias-aun" class="nav-list-link">8.8 Más tecnologías aún</a> </li></ul></li><li class="nav-list-item "><a href="/scv-git/" class="nav-list-link">Anexo I. Sistemas de control de versiones. Git</a></li></ul></li><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search DAW DOCS" aria-label="Search DAW DOCS" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/">Desarrollo Web en Entorno Servidor</a></li> <li class="breadcrumb-nav-list-item"><span>7 Ajax</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="7-ajax"> <a href="#7-ajax" class="anchor-heading" aria-labelledby="7-ajax"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Ajax </h1> <h2 id="71-un-poco-de-introducción-al-asunto"> <a href="#71-un-poco-de-introducción-al-asunto" class="anchor-heading" aria-labelledby="71-un-poco-de-introducción-al-asunto"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.1. Un poco de introducción al asunto </h2> <h2 id="711-qué-es-ajax"> <a href="#711-qué-es-ajax" class="anchor-heading" aria-labelledby="711-qué-es-ajax"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.1.1. ¿Qué es Ajax? </h2> <p><strong>Ajax</strong> significa <strong>Asynchronous Javascript And XML</strong>.</p> <p>Qué bien, ¿no?</p> <p>¿Y eso qué quiere decir?</p> <p>Ajax es una tecnología javascript para lanzar y recibir las peticiones al servidor en segundo plano. La página sigue funcionando con normalidad mientras la petición al servidor se resuelve: el usuario puede interactuar con ella y la página responde y no se queda <em>congelada</em> a la espera de que el servidor conteste.</p> <p><strong>Todo eso es lo que significa “de forma asíncrona”</strong>.</p> <p>Esta forma de trabajar, que puede parecer una chorrada, se creó para que las páginas dieran la impresión de ser más ágiles de lo que en realidad eran (sobre todo en una época en la que las redes eran más lentas y los servidores podían tardar bastante en responder).</p> <p>En la actualidad, Ajax ha permitido algo que parecía impensable hace una década: que gran parte de la página se ejecute en el cliente y que se pidan al servidor solo los fragmentos de la página que necesitan ser actualizados. Ajax permite actualizar las páginas sin necesidad de recargarlas por completo, lo que mejora la usabilidad y velocidad de respuesta, y cambia radicalmente nuestra forma de programar una aplicación web.</p> <h3 id="712-ajax-no-sirve-en-realidad-para-nada"> <a href="#712-ajax-no-sirve-en-realidad-para-nada" class="anchor-heading" aria-labelledby="712-ajax-no-sirve-en-realidad-para-nada"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.1.2. Ajax no sirve, en realidad, para nada </h3> <p>Esa es la pura verdad.</p> <p>Puedes programar una aplicación web completa, compleja y profesional sin hacer una sola petición Ajax.</p> <p>Pero Ajax mejora el rendimiento y la experiencia del usuario. Puedes sustituir unas pocas peticiones convencionales por peticiones Ajax sin cambiar demasiado en tu aplicación. Por ejemplo, para borrar un recurso, puedes lanzar la petición DESTROY por Ajax y actualizar tu vista para eliminar el recurso del documento HTML cuando el servidor responda.</p> <p>Esto es fácil de hacer. Y muy recomendable. Te aconsejo empezar a trastear con Ajax de este modo.</p> <h3 id="713-y-sin-embargo-ajax-ha-cambiado-la-forma-en-la-que-desarrollamos-aplicaciones-web"> <a href="#713-y-sin-embargo-ajax-ha-cambiado-la-forma-en-la-que-desarrollamos-aplicaciones-web" class="anchor-heading" aria-labelledby="713-y-sin-embargo-ajax-ha-cambiado-la-forma-en-la-que-desarrollamos-aplicaciones-web"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.1.3. Y, sin embargo, Ajax ha cambiado la forma en la que desarrollamos aplicaciones web </h3> <p>Como algo que, en realidad, no sirve para nada ha logrado cambiar la forma en la que desarrollamos aplicaciones web puede parecer un misterio a simple vista, pero existe una razón muy simple para ello:</p> <p>La mayoría de las aplicaciones web se pasan todo el tiempo haciendo lo mismo: accediendo a recursos de una base de datos para consultarlos, crearlos, modificarlos o borrarlos, todo ello mediante un interfaces de usuario básicamente semejantes. Es decir, el interfaz de usuario para crear, modificar y borrar productos de una base de datos es prácticamente el mismo que el que se usa para crear, modificar y borrar proveedores, por decir algo.</p> <p>Así que alguien se preguntó: ¿por qué estamos programando todo el tiempo lo mismo?</p> <p>Ajax nos permite hacer algo muy ingenioso para evitar este engorro: diseñar un interfaz de usuario genérico y vacío, solo compuesto por contenedores preparados para nutrirse de datos del servidor.</p> <p>Por ejemplo, podemos diseñar un típico interfaz de usuario HTML que nos muestre una lista de recursos (productos, proveedores, o lo que sea) junto con los botones de “Update” y “Delete”, además de un botón de “Add new”. Pero ese interfaz estará vacío, y mediante Ajax lo cargaremos con productos, con proveedores o con lo que necesitemos. Crearemos el interfaz una vez y lo podemos reutilizar miles de veces, para todo tipo de recursos.</p> <p>Este tipo de aplicaciones, también llamadas <strong>SPA (Single-page applications)</strong>, necesitan una arquitectura algo distinta de la que usamos en las aplicaciones web tradicionales, además de una librería en el lado del cliente para ayudarnos en la creación de contenedores genéricos (librerías como <strong>Angular</strong>, <strong>React</strong> o <strong>Vue.js</strong>). Aunque excede a nuestros propósitos profundizar en estas librerías, hemos visto algunos fundamentos sobre el uso de Vue.js con Laravel en el capítulo dedicado a Laravel. Consútalo si quieres profundizar en esta forma de uso masivo de Ajax.</p> <p>En lo que sigue de este capítulo, utilizaremos Ajax de forma puntual en el entorno de una aplicación web convencional con arquitectura MVC.</p> <h2 id="72-cómo-enviar-peticiones-ajax-al-servidor"> <a href="#72-cómo-enviar-peticiones-ajax-al-servidor" class="anchor-heading" aria-labelledby="72-cómo-enviar-peticiones-ajax-al-servidor"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.2. Cómo enviar peticiones Ajax al servidor </h2> <h3 id="721-peticiones-sin-datos-al-servidor"> <a href="#721-peticiones-sin-datos-al-servidor" class="anchor-heading" aria-labelledby="721-peticiones-sin-datos-al-servidor"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.2.1. Peticiones sin datos al servidor </h3> <p>La forma más sencilla (y primitiva) de usar Ajax es lanzar una petición asíncrona al servidor sin que el usuario de la web se percate de ello (porque se hará en segundo plano). El servidor no sabrá si la petición se lanzó en primer o en segundo plano y, en realidad, no le importa: él se limitará a atender la petición.</p> <p>Para lanzar una petición mediante Ajax usando JavaScript tradicional (luego veremos cómo hacerlo con jQuery, que simplifica bastante el proceso), necesitamos crear un objeto de tipo XMLHttpRequest. Este objeto nos permitirá controlar todo el proceso de envío de la petición, recepción de la posible respuesta y control de los errores que hayan podido ocurrir.</p> <p>Observa detenidamente este fragmento de código JavaScript:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">peticion_http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">procesa_respuesta</span><span class="p">;</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://servidor/recurso</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>


<span class="kd">function</span> <span class="nx">procesa_respuesta</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">peticion_http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">peticion_http</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">peticion_http</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>En las cuatro primeras líneas se crea el objeto de tipo XMLHttpRequest y luego se hacen tres cosas clave con él:</p> <ol> <li>Se le indica qué función se debe ejecutar cuando el servidor responda. Recuerda que esta función se ejecutará también en segundo plano, sin que el usuario de la página se percate de que está sucediendo algo.</li> <li>Se le indica qué recurso del servidor se quiere invocar (típicamente, una URL). Para ello se usa el método open(). Ahí también se indica el método de envío de datos al servidor (GET o POST), incluso si no se envían datos al servidor en absoluto, como en este ejemplo.</li> <li>Por último, se lanza la petición al servidor con el método send(). El argumento “null” debe sustituirse por los datos que se envían al servidor mediante GET en caso de que los hubiera.</li> </ol> <p>Eso deja lista la petición. JavaScript permanecerá a la escucha en segundo plano hasta que el servidor responda. Cuando lo haga, se ejecutará la función procesa_respuesta().</p> <p>En esa función se hacen tres cosas muy importantes:</p> <ol> <li>Se comprueba si el estado de la petición (readyState) es 4. Eso significa que el servidor ha terminado de procesarla. La petición pasa por varios estados hasta completarse, y el servidor informa de todos ellos. Es decir, la función procesa_respuesta() se ejecuta al menos una vez para cada uno de estos estados: <ul> <li>readyState == 1 -&gt; OPENED: Se acaba de abrir la comunicación con el servidor. Es decir, se acaba de ejecutar open().</li> <li>readyState == 2 -&gt; HEADERS_RECEIVED: Se acaba de enviar la petición al servidor. Es decir, se acaba de ejecutar send().</li> <li>readyState == 3 -&gt; LOADING: Se está recibiendo la respuesta del servidor.</li> <li>readyState == 4 -&gt; DONE: Se ha recibido la respuesta del servidor. Por eso es necesario comprobar que readyState == 4 antes de hacer ninguna otra cosa.</li> </ul> </li> <li>Se comprueba que la respuesta del servidor es 200. Esto, según el protocolo http, significa que no hay errores en la página. El servidor puede responder con otros códigos, como 404 (recurso no encontrado) o 403 (prohibido el acceso a ese recurso). Puedes encontrar en miles de sitios de internet todas las posibles respuestas de una petición http.</li> <li>Si readyState == 4 y status == 200, significa que todo ha ido bien y el servidor ha respondido. Ya podemos hacer lo que sea que tengamos que hacer con esa respuesta. En este ejemplo, nos hemos limitado a mostrar esa respuesta en un alert. Observa en el ejemplo como la respuesta del servidor se recibe en forma de String en el atributo responseText.</li> </ol> <h3 id="722-peticiones-con-datos-al-servidor-get"> <a href="#722-peticiones-con-datos-al-servidor-get" class="anchor-heading" aria-labelledby="722-peticiones-con-datos-al-servidor-get"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.2.2. Peticiones con datos al servidor (GET) </h3> <p>Si has entendido el ejemplo anterior, este te va a costar muy poco. Simplemente, vamos a enviar algunos datos al servidor por GET, exactament igual que lo haríamos si los enviáramos mediante un formulario. De hecho, el servidor no notará la diferencia.</p> <p>El código para lograrlo es este:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">codigo_postal</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">telefono</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">telefono</span><span class="dl">"</span><span class="p">);</span>
 
<span class="nx">query_string</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&amp;codigo_postal=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">cp</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">+</span>
               <span class="dl">"</span><span class="s2">&amp;telefono=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">telefono</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

<span class="nx">peticion_http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">procesa_respuesta</span><span class="p">;</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://servidor/scrip.php</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">query_string</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">procesa_respuesta</span><span class="p">()</span> <span class="p">{</span> <span class="p">....</span> <span class="p">}</span>
</code></pre></div></div> <p>No ponemos la función procesa_respuesta() porque es la misma de antes. En cambio, sí que hay algunos añadidos en el código de preparación de la solicitud, ¿verdad?</p> <p>Para empezar, hemos cogido un par de datos de un formulario: el código postal y el teléfono (puede ser un formulario de alta de usario o algo por el estilo: recuerda que esto solo es un ejemplo).</p> <p>Luego hemos creado una variable llamada queryString que contiene el string con los datos que queremos enviar al servidor por GET. Como los datos por GET se codifican en la URL, es necesario usar el formato de la URL (separando las variables con el carácter &amp;) y codificar cualquier carácter especial (con la función encodeURIComponente() de Javascript).</p> <p>Por último, en el momento de hacer send(), hemos agregado nuestra query_string para que sea enviada al servidor. Una vez allí, PHP la podrá procesar como cualquier otra string enviada por GET, es decir, usando las variables superglobales $_GET o $_REQUEST.</p> <h3 id="723-peticiones-con-datos-al-servidor-post"> <a href="#723-peticiones-con-datos-al-servidor-post" class="anchor-heading" aria-labelledby="723-peticiones-con-datos-al-servidor-post"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.2.3. Peticiones con datos al servidor (POST) </h3> <p>Si, en lugar de enviar datos al servidor por GET, preferimos enviarlos por POST, la técnica es muy similar a la anterior, con un par de variaciones:</p> <ol> <li>Debemos indicar “POST” en lugar de “GET” en el método open(), como es lógico.</li> <li>Debemos indicarle a Ajax que el paquete http llevará variables POST en su cabecera. Para eso se usa el método setRequestHeader().</li> </ol> <p>Lo puedes ver en el siguiente ejemplo:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">codigo_postal</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">telefono</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">telefono</span><span class="dl">"</span><span class="p">);</span>
 
<span class="nx">query_string</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&amp;codigo_postal=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">cp</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">+</span>
               <span class="dl">"</span><span class="s2">&amp;telefono=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">telefono</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

<span class="nx">peticion_http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">procesa_respuesta</span><span class="p">;</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">http://servidor/script.php</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">query_string</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">procesa_respuesta</span><span class="p">()</span> <span class="p">{</span> <span class="p">....</span> <span class="p">}</span>
</code></pre></div></div> <h3 id="724-peticiones-con-datos-al-servidor-xml"> <a href="#724-peticiones-con-datos-al-servidor-xml" class="anchor-heading" aria-labelledby="724-peticiones-con-datos-al-servidor-xml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.2.4. Peticiones con datos al servidor (XML) </h3> <p>Todo esto está muy bien si lo que enviamos al servidor son un par de datos sueltos, como el código postal y el teléfono en los ejemplos anteriores. Pero ¿y si tenemos que enviar mucha información? Digamos, por ejemplo, un array de códigos postales y teléfonos.</p> <p>En ese caso, usar GET se hace inviable (por la limitación de caracteres), así que recurriremos a POST y empaquetaremos nuestros datos en un string XML o JSON. En este ejemplo, vamos a usar XML:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">codigo_postal</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">telefono</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">telefono</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">xml</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;datos&gt;</span><span class="dl">"</span> <span class="o">+</span>
      <span class="dl">"</span><span class="s2">&lt;cp&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">cp</span> <span class="o">+</span> <span class="o">&lt;</span><span class="sr">/cp&gt;" + &lt;telefono&gt; + telefono + &lt;/</span><span class="nx">telefono</span><span class="o">&gt;</span> <span class="o">+</span>
      <span class="dl">"</span><span class="s2">&lt;/datos&gt;</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">peticion_http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">procesa_respuesta</span><span class="p">;</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">http://servidor/script.php</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">peticion_http</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">xml</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">procesa_respuesta</span><span class="p">()</span> <span class="p">{</span> <span class="p">....</span> <span class="p">}</span>
</code></pre></div></div> <h2 id="73-cómo-recibir-la-respuesta-del-servidor"> <a href="#73-cómo-recibir-la-respuesta-del-servidor" class="anchor-heading" aria-labelledby="73-cómo-recibir-la-respuesta-del-servidor"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.3. Cómo recibir la respuesta del servidor </h2> <p>En todos los ejemplos anteriores, el servidor conestaba con un simple texto que mostrábamos por medio de un alert() de Javascript. Ni siquiera nos preocupamos por el contenido de ese texto. Podría ser cualquier cosa: algo como “petición procesada”, “usuario borrado” o cosas por el estilo.</p> <p>Pero ¿y si el servidor tiene que contestar algo complejo? Por ejemplo, una tabla completa. En ese caso, como es lógico, necesitamos recurrir a XML o JSON para empaquetar todos los datos de la respuesta y enviarlos desde el servidor hacia el cliente.</p> <p>Vamos a ver un par de ejemplo, uno resuelto con XML y otro con JSON. En ninguno de los dos casos mostraremos cómo lo hace el servidor para crear los datos: supondremos que eso ya sabes hacerlo, puesto que se trata de PHP. Nos centraremos en cómo procesa Ajax, es decir, Javascript, esa respuesta.</p> <h3 id="731-recepción-de-datos-xml"> <a href="#731-recepción-de-datos-xml" class="anchor-heading" aria-labelledby="731-recepción-de-datos-xml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.3.1. Recepción de datos XML </h3> <p>En este ejemplo, el servidor nos devuelve un String XML consistente en un array de códigos postales y teléfonos (de clientes, de usuarios, de lo que sea. Recuerda -otra vez- que solo es un ejemplo).</p> <p>Observa cómo esa respuesta se accede por medio de responseXML (no responseText, como hasta ahora). A partir de ahí, Javascript puede usar esa respuesta como un objeto XML cualquiera: puede buscar hijos de un nodo, puede buscar nodos por su tag, etc.</p> <p>En el ejemplo, nos limitamos a recuperar el código postal y el teléfono del primer elemento del array y a mostrarlo en el documento preexistente, en una capa con el ID “respuesta”.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">procesaRespuesta</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">peticion_http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">peticion_http</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="nx">peticion_http</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">datos</span> <span class="o">=</span> <span class="nx">xml</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">datos</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">telefono</span> <span class="o">=</span> <span class="nx">datos</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">telefono</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
                     <span class="nx">firstChild</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="nx">datos</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">cp</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span>
               <span class="nx">firstChild</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">;</span>
 
      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">respuesta</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> 
             <span class="dl">"</span><span class="s2">Codigo postal = </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">codigo_postal</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br/&gt;</span><span class="dl">"</span> <span class="o">+</span> 
             <span class="dl">"</span><span class="s2">Telefono = </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">telefono</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="732-recepción-de-datos-json"> <a href="#732-recepción-de-datos-json" class="anchor-heading" aria-labelledby="732-recepción-de-datos-json"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.3.2. Recepción de datos JSON </h3> <p>Javascript prefiere JSON a XML, es no es un secreto. Casi todos los programadores lo prefieren, en realidad. Así que veamos cómo hacer lo mismo que antes, pero ahora con JSON.</p> <p>La respuesta JSON llegará en responseText, no en responseXML. Eso significa que Javascript la recibe como un String cualquiera.</p> <p>Luego, con la función eval() de Javascript, podemos convertir ese String en un objeto complejo y, a partir de ahí, usar ese objeto para acceder a todos sus elementos.</p> <p>En el ejemplo, como antes, solo accederemos al primer código postal y al primer teléfono y los mostraremos en la capa “respuesta” de nuestro documento.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">procesaRespuesta</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">http_request</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">http_request</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">http_request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">objeto_json</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="dl">"</span><span class="s2">(</span><span class="dl">"</span><span class="o">+</span><span class="nx">json</span><span class="o">+</span><span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">telefono</span> <span class="o">=</span> <span class="nx">objeto_json</span><span class="p">.</span><span class="nx">datos</span><span class="p">.</span><span class="nx">telefono</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">codigo_postal</span> <span class="o">=</span> <span class="nx">objeto_json</span><span class="p">.</span><span class="nx">datos</span><span class="p">.</span><span class="nx">cp</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">respuesta</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> 
             <span class="dl">"</span><span class="s2">Codigo postal = </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">codigo_postal</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br/&gt;</span><span class="dl">"</span> <span class="o">+</span> 
             <span class="dl">"</span><span class="s2">Telefono = </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">telefono</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="74-ajax-y-jquery"> <a href="#74-ajax-y-jquery" class="anchor-heading" aria-labelledby="74-ajax-y-jquery"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4. Ajax y jQuery </h2> <p>El uso de jQuery facilita enormemente la programación de llamadas Ajax al servidor. El decir: se puede manejar Ajax al 100% sin recurrir a jQuery, pero con jQuery es más fácil.</p> <p>jQuery ofrece varias funciones para hacer llamadas Ajax:</p> <ul> <li>$.ajax() → La más configurable pero también la más compleja.</li> <li>$.get() → Para lanzar peticiones GET sencillas.</li> <li>$.post() → Para lanzar peticiones POST sencillas</li> <li>$.load() → Para lanzar peticiones GET y cargar la respuesta en una capa.</li> </ul> <p>Vamos a verlas una por una.</p> <h3 id="741-función-ajax"> <a href="#741-función-ajax" class="anchor-heading" aria-labelledby="741-función-ajax"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.1. Función $.ajax() </h3> <p>Tiene esta sintaxis:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/ruta/hasta/script.php</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="dl">'</span><span class="s1">parametro1=valor1&amp;parametro2=valor2</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">contentType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tipo de contenido que enviamos al servidor</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">dataType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tipo de contenido con el que responde el servidor</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Aquí el código para procesar la respuesta },</span>
  <span class="na">fail</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// Aquí el código para procesar el error }</span>
<span class="p">});</span>
</code></pre></div></div> <p>Bueno, en realidad $.ajax() admite más argumentos aparte de los que te muestro aquí arriba, pero estos son los principales. Si quieres verlos todos, te sugiero que te des una vuelta por la documentación oficial de jQuery, que por cierto es fantásticamente buena.</p> <p>Observa como, en una sola invocación, conseguimos hacerlo todo: indicar la URL donde se dirigirá la petición, el tipo de envío de datos (GET o POST), los datos que enviamos al servidor, el tipo de datos que recibiremos como respuesta, el nombre de la función que procesará la respuesta e, incluso, el nombre de la función que procesará el error, en caso de que el servidor responda con un código de error.</p> <p>En <strong><em>contentType</em></strong> puedes indicar el tipo de datos que vas a enviar al servidor. Por defecto, se supone que es ‘application/x-www-form-urlencoded; charset=UTF-8’, pero te puede interesar cambiarlo por ‘multipart/form-data’, por ejemplo, si vas a enviar un archivo binario (como una imagen).</p> <p>En <strong><em>dataType</em></strong> puedes indicar el tipo de datos que se espera que te devuelva el servidor. Por defecto será ‘text’, es decir, texto plano, pero puedes indicar cosas muy variadas, como ‘xml’, ‘json’, ‘html’ o incluso ‘script’ si el servidor te va a devolver un fragmento de código JavaScript. Esto ayuda a su procesamiento posterior en la sección <strong><em>success</em></strong>.</p> <p>Por último, en la sección <strong><em>success</em></strong> puedes acceder a los datos devueltos por el servidor a través de la variable <strong><em>data</em></strong>, que tendrá el formato correspondiente al tipo de datos que hayas indicado en <strong><em>dataType</em></strong>. Por ejemplo, si en <strong><em>dataType</em></strong> especificaste que el servidor iba a responder con un objeto json, jQuery tratará de convertir la respuesta a un objeto asumiendo el formato json y te la dejará preparada y lista para usar en el parámetro <strong><em>data</em></strong>.</p> <p>Aquí vemos un ejemplo de uso de $.ajax():</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mi-script.php</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span><span class="na">email</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#email</span><span class="dl">"</span><span class="p">).</span><span class="nx">val</span><span class="p">()},</span>
      <span class="na">success</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#message</span><span class="dl">"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
               <span class="p">},</span>
      <span class="na">error</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">alert</span><span class="p">(</span><span class="nx">req</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">status</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
             <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
</code></pre></div></div> <p>Si es la primera vez que ves código jQuery, esto te sonará tanto como el chino mandarín. Pero no te agobies, que en realidad es muy fácil. Te lo explico en cuatro frases.</p> <p>La primera línea, <strong><em>$(document).ready()</em></strong>, sirve para indicar al navegador que no debe ejecutar la función que haya ahí dentro hasta que el documento no se haya cargado por completo y el árbol DOM desplegado en la memoria del cliente. Solo entonces se lanzará el resto del código. Es algo muy común en el código jQuery.</p> <p>Después viene la llamada Ajax, con varios de los atributos que mencionábamos antes. Fíjate que no hemos usado ni <strong><em>dataType</em></strong> ni <strong><em>contentType</em></strong>, por lo que se asumirán los valores por defecto.</p> <p>En la sección <strong><em>data</em></strong> se especifican los datos que se envían a mi-script.php. Solo enviamos un email, pero podríamos enviarle más cosas. Observa que lo hemos formateado en json. Es lo más habitual.</p> <p>En la sección <strong><em>success</em></strong> hemos colocado directamente el código de la función que se lanzará al recibir la respuesta del servidor. Esa forma de inyectar funciones sin nombre directamente es muy habitual de jQuery. La función se limita a tomar la respuesta del servidor y mostrarla en una capa con el ID “#message”, pero, por supuesto, podría hacer cualquier otra cosa más compleja.</p> <p>En la sección <strong><em>error</em></strong>, por último, lanzamos un mensaje de error mediante un alert(), que solo saltará si ocurre algún error durante la petición Ajax. Fíjate en que esa función tiene tres parámetros (optativos) que utilizamos para informar al usuario con más detalle de qué error se ha producido.</p> <h3 id="742-funciones-get-y-post"> <a href="#742-funciones-get-y-post" class="anchor-heading" aria-labelledby="742-funciones-get-y-post"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.2. Funciones $.get() y $.post </h3> <p>En muchas ocasiones, no necesitamos usar ni la mínima parte de las posibilidades de la función $.ajax(). Cuando tenemos que hacer una llamada sencillita por Ajax al servidor y no queremos complicarnos la vida, puede ser más útil y rápido recurrir a las funciones $.get() y $.post().</p> <p>Como su propio nombre indica, $.get() lanza una petición Ajax mediante GET y $.post() hace lo mismo, pero con POST. Su sintaxis es esta:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">datos</span><span class="p">,</span> <span class="nx">funcion_manejadora</span><span class="p">);</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">datos</span><span class="p">,</span> <span class="nx">funcion_manejadora</span><span class="p">);</span>
</code></pre></div></div> <p>Aquí tienes un ejemplo en el que llamamos por Ajax a <strong><em>mi-script.php</em></strong>, enviándole mediante GET un nick de usuario. El servidor responderá con un texto plano que contendrá el nombre de ese usuario y lo mostrará mediante un alert():</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">mi-script.php</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">juanperez03</span><span class="dl">'</span> <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hola, </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">username</span><span class="p">);</span>
      <span class="p">}</span>
<span class="p">);</span>
</code></pre></div></div> <h3 id="743-función-load"> <a href="#743-función-load" class="anchor-heading" aria-labelledby="743-función-load"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.3. Función $.load() </h3> <p>Un caso particularmente simple (y habitual) de uso de Ajax es aquel en el que lanzamos una petición al servidor para rellenar una capa de nuestra página con la información que el servidor nos devuelve.</p> <p>Por ejemplo, imagina que tenemos un formulario de registro de usuarios y, en el campo del nick del usuario, deseamos comprobar si ese nick ya está en uso en la base de datos. Mediante Ajax, se puede hacer de forma dinámica y atractiva capturando el evento onblur en del campo nick y lanzando en ese momento una petición Ajax al servidor para que haga la consulta a la base de datos.</p> <p>Si el usuario ya existe, el servidor puede responder con un texto el tipo “Ese usuario ya existe”. En caso contrario, puede responder con “Ese nick está disponible” o algo así. En ambos casos, ese String puede mostrarse en una capa junto al cuadro de texto, una capa que, hasta ese momento, habrá estado vacía.</p> <p>Este escenario tan habitual se puede resolver con $.ajax(), con $.get() o con $.post(), pero existe una función jQuery específica para ello. Se llama $.load() y tiene esta sintaxis:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#info</span><span class="dl">'</span><span class="p">).</span><span class="nx">load</span><span class="p">(</span><span class="dl">'</span><span class="s1">mi-script.php</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div> <p>Simplemente, se ejecuta <strong><em>mi-script.php</em></strong> en el servidor y se carga el texto de respuesta en la capa #info. Sin funcion manejadora ni historias. Más fácil, imposible, ¿verdad?</p> <h2 id="75-ajax-y-laravel"> <a href="#75-ajax-y-laravel" class="anchor-heading" aria-labelledby="75-ajax-y-laravel"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.5. Ajax y Laravel </h2> <p>Al trabajar con Laravel, estamos acostumbrados a que cada método del controlador termine devolviendo una vista completa (retur view…). ¿Pero qué pasa si hacemos una petición Ajax a una aplicación web escrita con Laravel en el lado del servidor?</p> <p>Laravel puede continuar devolviendo una vista completa, pero es no suele ser lo que Ajax espera recibir como respuesta. Ajax espera respuestas cortas y concisas: algo como ‘true’ o ‘false’, o un número, o un String o, como mucho, una estructura de datos más compleja formateada en XML o JSON. Pero no una página web completa con su cabecera, su cuerpo y toda la parafernalia.</p> <p>Y eso es precisamente lo que devuelve Laravel al rederizar cualquier vista. Así que, ¿cómo lo hacemos?</p> <h3 id="751-paso-1-crear-un-controlador-para-las-peticiones-ajax"> <a href="#751-paso-1-crear-un-controlador-para-las-peticiones-ajax" class="anchor-heading" aria-labelledby="751-paso-1-crear-un-controlador-para-las-peticiones-ajax"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.5.1. Paso 1. Crear un controlador para las peticiones Ajax </h3> <p>Esto no es imprescindible, pero sí suele ser una práctica habitual: reunir todas las peticiones Ajax en un único controlador.</p> <p>Ten en cuenta que, para el servidor, no hay diferencia entre una petición Ajax y una petición normal. El servidor recibe su petición por http o https y la atiende, ejecutando en enrutador, el controlador y todo lo que venga detrás, y produciendo una salida como resultado que se envía de vuelta al cliente. Punto.</p> <p>Así que suele ser buena idea separar las peticiones Ajax de las peticiones normales mediante la diferenciación de controladores, salvo que tengas una muy biena razón para no hacerlo.</p> <p>Por lo tanto, crearemos un controlador AjaxController y añadiremos a nuestro enrutador (/routes/web.php) las líneas correspondientes, como esta:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Route</span><span class="o">::</span><span class="nf">post</span><span class="p">(</span><span class="s1">'miJqueryAjax'</span><span class="p">,</span><span class="s1">'AjaxController@miMetodo'</span><span class="p">);</span>
</code></pre></div></div> <h3 id="752-paso-2-crear-los-métodos-del-controlador-ajaxcontroller"> <a href="#752-paso-2-crear-los-métodos-del-controlador-ajaxcontroller" class="anchor-heading" aria-labelledby="752-paso-2-crear-los-métodos-del-controlador-ajaxcontroller"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.5.2. Paso 2. Crear los métodos del controlador AjaxController </h3> <p>Lo siguiente sería crear los métodos que necesitemos en AjaxController (o, si hemos decidido no crear un controlador específico para Ajax, crear los métodos en los controladores que corresponda).</p> <p>Solo hay que tener una cosa clara: estos métodos que responderán a las peticiones Ajax <strong>no pueden terminar con una vista</strong>.</p> <p>Imagina un método que reponderá a una petición Ajax y que solo deba responder con un String, cuyo valor pueda ser “Ese usuario ya existe” o “Usuario disponible”. Lo haríamos así:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AjaxController</span> <span class="kd">extends</span> <span class="nc">Controller</span> <span class="p">{</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">miMetodo</span><span class="p">()</span> <span class="p">{</span>
     <span class="mf">...</span><span class="n">aquí</span> <span class="n">va</span> <span class="n">mi</span> <span class="n">código</span><span class="mf">...</span> 
     <span class="k">if</span> <span class="p">(</span><span class="nv">$lo_que_sea</span><span class="p">)</span> <span class="nv">$result</span> <span class="o">=</span> <span class="s2">"Ese usuario ya existe"</span><span class="p">;</span>
     <span class="k">else</span> <span class="nv">$result</span> <span class="o">=</span> <span class="s2">"Usuario disponible"</span><span class="p">;</span>
     <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Imagina ahora que queremos devolver algo más complicado, como un array o una colección de datos. No pasa nada: los formateamos como json y los enviamos de regreso al cliente, así:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AjaxController</span> <span class="kd">extends</span> <span class="nc">Controller</span> <span class="p">{</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">miMetodo</span><span class="p">()</span> <span class="p">{</span>
     <span class="mf">...</span><span class="n">aquí</span> <span class="n">va</span> <span class="n">mi</span> <span class="n">código</span><span class="mf">...</span> 
      <span class="k">return</span> <span class="nf">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">json</span><span class="p">(</span><span class="nv">$mi_variable_compleja</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Por supuesto, esta última manera también te funcionará para devolver un simple String, un booleano o un entero. Es la forma más conveniente de terminar un método de un controlador que va a ser invocado por Ajax y no mediante una petición normal al servidor.</p> <p>Ten en cuenta que:</p> <ul> <li>La salida de una petición Ajax suele ser JSON, pero podría ser otra cosa: HTML, XML o simple texto plano.</li> <li>Lo repetimos una vez más: para responder a una petición Ajax no se debe renderizar una vista (¡salvo que tengas una muy buena excusa para hacerlo!), sino que basta con un return response().</li> </ul> <h3 id="753-agregar-el-token-csrf-a-las-peticiones"> <a href="#753-agregar-el-token-csrf-a-las-peticiones" class="anchor-heading" aria-labelledby="753-agregar-el-token-csrf-a-las-peticiones"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.5.3. Agregar el token CSRF a las peticiones </h3> <p>Como vimos al estudiar Laravel, las peticiones enviadas por POST con Laravel deben llevar el token CSRF o serán rechazadas. Esto se hacía para prevenir cierto tipo de ataques frecuentes a través de formularios HTML. Los detalles no son importantes aquí y, en todo caso, puedes repasar el capítulo sobre Laravel o sobre Sesiones, Cookies y Seguridad para revisar el concepto.</p> <p>Lo importante ahora es esto: cuando lances una petición POST mediante Ajax, Laravel la rechazará porque no llevará el token CSRF. Recuerda que el servidor no tiene ni idea de si la petición llega desde Ajax o no: para él, se trata de datos que provienen de un formulario HTML, y si no lleva ese token, automáticamente se convierte en un formulario sospechoso.</p> <p>Así que, si tienes Laravel en el lado del servidor, necesitas agregar el token CSRF a las peticiones por POST, así:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
     <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
     <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mi-url</span><span class="dl">"</span><span class="p">,</span>
     <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
         <span class="dl">"</span><span class="s2">_token</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span>
     <span class="p">},</span>
     <span class="p">...</span><span class="nx">etc</span><span class="p">...</span> 
<span class="p">});</span>
</code></pre></div></div> <p>Por supuesto, puedes añadir más <strong><em>data</em></strong> a tu petición: tantos datos como necesites enviar al servidor.</p> <p>Como esto puede ser un poco engorroso, hay una forma de agregar automáticamente el token CSRF a <strong>todas</strong> las peticiones. Basta con escribir esto en el header de nuestro layout:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"csrf-token"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
   <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
          <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
             <span class="dl">'</span><span class="s1">X-CSRF-TOKEN</span><span class="dl">'</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">meta[name="csrf-token"]</span><span class="dl">'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="dl">'</span><span class="s1">content</span><span class="dl">'</span><span class="p">)</span>
          <span class="p">}</span>
      <span class="p">});</span>
   <span class="nt">&lt;/script&gt;</span>
</code></pre></div></div> <p>A partir de ahora, podremos hacer las peticiones Ajax normalmente, porque el token CSRF se añadirá él solito a cada petición Ajax.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
