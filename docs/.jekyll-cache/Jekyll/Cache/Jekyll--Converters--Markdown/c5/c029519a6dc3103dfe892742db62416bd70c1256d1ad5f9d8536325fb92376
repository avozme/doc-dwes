I"”D<h2 id="510-migraciones">5.10. Migraciones</h2>

<h3 id="5101-qu√©-son-las-migraciones">5.10.1. ¬øQu√© son las migraciones?</h3>

<p>Las migraciones constituyen una especie de control de versiones para la base de datos de la aplicaci√≥n. Permiten crear y modificar tablas de la BD con independencia del SGBD que estemos usando.</p>

<p>Con las migraciones no solo podr√°s reconstruir la base de datos en menos de lo que tarda en decirse ‚ÄúVon Neumann‚Äù (algo muy pr√°ctico cuando est√°s en fase de desarrollo), sino que podr√°s parchear la base de datos de una aplicaci√≥n en producci√≥n en un tiempo record y con riesgo cero. Solo el que ha tenido que parchear la base de datos de una aplicaci√≥n en producci√≥n antes de la existencia de las migraciones sabe la tranquilidad de esp√≠ritu que esto produce y la cantidad de problemas embarazosos que te quita de encima.</p>

<p>Antes de empezar, recuerda que, para que cualquier operaci√≥n sobre la base de datos funcione, debes tener bien configurados estas variables de entorno del archivo .env de Laravel:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DB_HOST=localhost
DB_DATABASE=mi-base-de-datos
DB_USERNAME=mi-usuario-de-BD
DB_PASSWORD=mi-password-de-BD
</code></pre></div></div>

<h3 id="5102-crear-tablas-mediante-las-migraciones">5.10.2. Crear tablas mediante las migraciones</h3>

<p>Si, por ejemplo, quisi√©ramos crear las migraciones de una tabla llamada Clients, los pasos a seguir ser√≠an:</p>

<p><strong>Paso 1</strong>: Inicializar el sistema de migraciones de Laravel (si ya lo hemos hecho antes, nos dar√° un error al intentar hacerlo otra vez):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:install
</code></pre></div></div>

<p><strong>Paso 2</strong>: Crear la migraci√≥n para la tabla Clients:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan make:migration create_clients_table
</code></pre></div></div>

<p>Esto generar√° un fichero en /database/migrations cuyo nombre contendr√° un timestamp. Algo como /database/migrations/20201226072434createclientstable.php</p>

<p>Si editas ese fichero, ver√°s dos m√©todos:</p>

<ul>
  <li>up() ‚Üí se ejecuta cuando se lanza la migraci√≥n.</li>
  <li>down() ‚Üí se ejecuta cuando se cancela la migraci√≥n.</li>
</ul>

<p><strong>Paso 3</strong>: Editar el fichero /database/migrations/<timestamp>createclientstable.php:</timestamp></p>

<p>En el m√©todo up() tienes que indicar las columnas que tendr√° la tabla. Por ejemplo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">up</span><span class="p">()</span> <span class="p">{</span>
    <span class="nc">Schema</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span><span class="s1">'clients'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
       <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">bigIncrements</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">index</span><span class="p">();</span><span class="c1">// UNSIGNED BIGINT AUTOINC.</span>
       <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">string</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">unique</span><span class="p">();</span> <span class="c1">// VARCHAR</span>
       <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">text</span><span class="p">(</span><span class="s1">'address'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">nullable</span><span class="p">();</span> <span class="c1">// TEXT</span>
       <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">integer</span><span class="p">(</span><span class="s1">'level'</span><span class="p">);</span>            <span class="c1">// INT</span>
       <span class="nv">$table</span><span class="o">-&gt;</span><span class="nb">date</span><span class="p">(</span><span class="s1">'brith_date'</span><span class="p">);</span>          <span class="c1">// DATE</span>
       <span class="c1">// La siguiente l√≠nea crea campos created_at y updated_at. Si la borras</span>
       <span class="c1">// esos campos no existir√°n en tu tabla</span>
       <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">timestamps</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">down</span><span class="p">()</span> <span class="p">{</span>
    <span class="nc">Schema</span><span class="o">::</span><span class="nf">drop</span><span class="p">(</span><span class="s1">'clients'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Paso 4</strong>: Lanzar las migraciones.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate
</code></pre></div></div>

<p>Esto crear√° las tablas que no se hayan creado a√∫n. Es decir, si una migraci√≥n ya se ha lanzado con anterioridad, no se vuelve a ejecutar para no perder los datos que pudieran existir en esas tablas.</p>

<p><strong>Paso 5</strong>: Revertir las migraciones (si es necesario)</p>

<p>Si necesitas revertir la creaci√≥n de todas las tablas:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:rollback
</code></pre></div></div>

<p>Para revertir solo el √∫ltimo paso en la creaci√≥n de tablas:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:rollback --step=1
</code></pre></div></div>

<p>Para dejar la BD a su estado original (vac√≠a):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:reset
</code></pre></div></div>

<p>¬°Cuidado! Estas acciones son destructivas. Pero, por supuesto, hay una forma de modificar una tabla sin borrarla y volver a crearla.</p>

<h3 id="5103-modificar-tablas-mediante-migraciones">5.10.3. Modificar tablas mediante migraciones</h3>

<p>Si necesitas modificar una tabla que ya existe (por ejemplo, para a√±adir o eliminar campos), tienes dos opciones:</p>

<ol>
  <li>Modificar la migraci√≥n original (en la que se crea la tabla) para a√±adir o eliminar el campo afectado. Esto te obligar√° a lanzar la migraci√≥n de nuevo y, por lo tanto, la tabla se reconstruir√° y todos los datos que pudiera contener se perder√°n.</li>
  <li>Crear una nueva migraci√≥n en la que √∫nicamente se haga la modificaci√≥n de la tabla, sin tocar el resto. Esto respetar√° los datos que la tabla ya pudiera contener.</li>
</ol>

<p>Como es l√≥gico, la opci√≥n 2 ser√° la que preferiremos si la aplicaci√≥n ya est√° en producci√≥n y necesitamos modificar la estructura de la base de datos. En cambio, durante el desarrollo, puede ser m√°s simple utilizar la opci√≥n 1.</p>

<p>Supongamos que queremos a√±adir un campo ‚Äúemail‚Äù a la tabla ‚ÄúClients‚Äù del apartado anterior. Si optas por la opci√≥n 2, es decir, por crear una nueva migraci√≥n que se encargue de hacer esa modificaci√≥n en la tabla sin alterar sus datos, la forma de proceder es la siguiente:</p>

<p><strong>Paso 1</strong>. Crear la migraci√≥n:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan make:migration add_email_to_clients --table=clients
</code></pre></div></div>

<p>(Nota: puedes asignar el nombre que quieras a las migraciones, pero Laravel aconseja utilizar las convenciones que ves en estos ejemplos para simplificarnos la vida)</p>

<p><strong>Paso 2</strong>: Editar la migraci√≥n /database/migration/add_email_to_clients.php para a√±adir, en el m√©todo up(), el campo nuevo; y, en el m√©todo down(), especificaremos qu√© hay que hacer en caso de que se fuerce un rollback de esta migraci√≥n:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">up</span><span class="p">()</span> <span class="p">{</span>
        <span class="nc">Schema</span><span class="o">::</span><span class="nf">table</span><span class="p">(</span><span class="s1">'clients'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">string</span><span class="p">(</span><span class="s1">'email'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">after</span><span class="p">(</span><span class="s1">'address'</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">down</span><span class="p">()</span> <span class="p">{</span>
        <span class="nc">Schema</span><span class="o">::</span><span class="nf">table</span><span class="p">(</span><span class="s1">'clients'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">dropColumn</span><span class="p">(</span><span class="s1">'email'</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="5104-otras-operaciones-en-las-migraciones">5.10.4. Otras operaciones en las migraciones</h3>

<p>Las migraciones pueden usarse para cualquier otra operaci√≥n sobre la estructura de la base de datos, como:</p>

<ul>
  <li>Cambiar tipos de columnas.</li>
  <li>Cambiar atributos de columnas (null, unique, default‚Ä¶)</li>
  <li>Cambiar o asignar claves primarias y ajenas.</li>
</ul>

<p>Las migraciones constru√≠das de este modo nos permitir√°n reproducir la base de datos en cualquier servidor o actualizarla en cualquier momento sobre una aplicaci√≥n en producci√≥n sin necesidad de programar parches o exportar la BD a un archivo SQL para importarlo en otro servidor.</p>

<p>M√°s info en: <a href="https://laravel.com/docs/8.x/migrations">https://laravel.com/docs/8.x/migrations</a></p>

<h3 id="5105-seeding">5.10.5. Seeding</h3>

<p>El seeding es una t√©cnica adicional a la de las migraciones que permite cargar con datos las tablas de la base de datos. Es muy pr√°ctico en estos supuestos:</p>

<ul>
  <li>Si quieres tener un conjunto de datos de prueba en tu base de datos de desarrollo (esa que destrozas peri√≥dicamente cuando haces pruebas). Con un solo comando, tendr√°s la base de datos reconstru√≠da como si no hubieras ejecutado un ‚ÄúDELETE * FROM users‚Äù sin querer.</li>
  <li>Si necesitas cargar algunos datos m√≠nimos en algunas tablas para que la aplicaci√≥n, una vez desplegada en un servidor de producci√≥n, funcione (por ejemplo, para crear un usuario administrador en la tabla ‚ÄúUsers‚Äù o para crear algunas entradas en una tabla ‚ÄúOptions‚Äù)</li>
</ul>

<p>Para crear un seeder (por ejemplo, para la tabla users), sigue estos pasos:</p>

<p><strong>Paso 1</strong>. Ejecuta el comando:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan make:seeder UsersTableSeeder
</code></pre></div></div>

<p><strong>Paso 2</strong>. Editar el seeder /database/seeds/UsersTableSeeder.php y a√±ade algo como esto al m√©todo up() (por supuesto, modifica el c√≥digo para adaptarlo a tu tabla y a tus datos):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="nc">Users</span><span class="o">::</span><span class="nf">truncate</span><span class="p">();</span>  <span class="c1">// Opativo: vac√≠a la tabla antes de rellenarla</span>
        <span class="no">DB</span><span class="o">::</span><span class="nf">table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">insert</span><span class="p">([</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Stephen Falken'</span><span class="p">,</span>
            <span class="s1">'address'</span> <span class="o">=&gt;</span> <span class="s1">' Oregon 97, Goose Island'</span><span class="p">,</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'sfalken@norad.com'</span><span class="p">,</span>
            <span class="s1">'brith_date'</span> <span class="o">=&gt;</span> <span class="s1">'1932-09-03'</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><strong>Paso 3</strong>. Ejecuta este comando para lanzar el seeder y que los datos se carguen en tu tabla:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan db:seed --class=UsersTableSeeder
</code></pre></div></div>

<p>Esto cargar√° un solo registro en la tabla users. Si quieres m√°s, solo tienes que crear nuevas l√≠neas insert() en el m√©todo up().</p>

<h3 id="5105-automatizar-el-seeding">5.10.5. Automatizar el seeding</h3>

<p>Lanzar los seeders de uno en uno puede ser muy tedioso. Puedes lanzar varios seeders con un solo comando si haces lo siguiente:</p>

<p><strong>Paso 1</strong>. Edita el fichero /database/seeds/DatabaseSeeder.php</p>

<p><strong>Paso 2</strong>. A√±ade a la funci√≥n run() una l√≠nea como esta por cada seeder que quiera ejecutar autom√°ticamente:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">call</span><span class="p">(</span><span class="nc">UsersTableSeeder</span><span class="o">::</span><span class="n">class</span><span class="p">);</span> 
</code></pre></div></div>

<p><strong>Paso 3</strong>. ¬°Y listo! Al ejecutar el comando db:seed de Artisan, sin indicar la clase, se lanzar√°n todos los seeders que hayas aladido a run():</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan db:seed
</code></pre></div></div>

<h3 id="5106-lista-de-comandos-super√∫tiles-para-manejar-migraciones">5.10.6. Lista de comandos super√∫tiles para manejar migraciones</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate ‚Üí Lanza todas las migraciones.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan make:migration &lt;nombre&gt; --create=&lt;tabla&gt; ‚Üí Crea una migraci√≥n para la tabla indicada.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan make:migration &lt;nombre&gt; --table=&lt;tabla&gt; ‚Üí Modifica una migraci√≥n para la tabla indicada.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:rollback ‚Üí Retrocede UN paso en todas las migraciones.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:rollback --step=&lt;N&gt; ‚Üí Retrocede N pasos en todas las migraciones.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:reset ‚Üí Deshace todas las migraciones que se hayan ejecutado hasta ahora.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:refresh ‚Üí Reset + migrate en un solo comando.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:refresh --seed ‚Üí Reset + migrate + seed en un solo comando.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:fresh ‚Üí Elimina todas las tablas y lanza todas las migraciones.
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ php artisan migrate:fresh --seed ‚Üí Elimina todas las tablas, lanza todas las migraciones y todos los seeders.
</code></pre></div></div>
:ET