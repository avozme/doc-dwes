I"¥∞<h1 id="4-arquitectura-mvc">4. Arquitectura MVC</h1>

<p>Cuando hablamos de arquitectura de una aplicaci√≥n web nos referimos a la estructura b√°sica que la sustenta, como los pilares de un edificio en construcci√≥n. Si quitas las paredes, las ventanas, las puertas, los azulejos de la cocina‚Ä¶ todav√≠a pueden distinguirse las formas fundamentales, ¬øverdad?</p>

<p>En este tema, hablaremos mucho de la arquitectura m√°s popular en aplicaciones web (llamada MVC; no te preocupes, pronto se convertir√° en tu mejor amiga). Pero, antes, vamos a darle una vuelta al t√©rmino ‚Äúarquitectura‚Äù, porque en aplicaciones web se usa con dos significados distintos que conviene que tengas claros para no hacerte un l√≠o.</p>

<h2 id="41-arquitecturas-f√≠sicas-multinivel-multitier">4.1 Arquitecturas F√çSICAS multinivel (multitier)</h2>

<p>Hablamos indistintamente de ‚Äúarquitectura de una aplicaci√≥n web‚Äù para referirnos a dos cosas distintas: la arquitectura f√≠sica y la arquitectura l√≥gica. Y ah√≠ empiezan los l√≠os.</p>

<p>Vamos a intentar desliarnos antes de apretar el nudo.</p>

<p>Una <strong>arquitectura f√≠sica de varios niveles</strong> (multinivel o multitier, en ingl√©s) consiste en un conjunto de ordenadores conectados a una red que ejecutan de forma conjunta una aplicaci√≥n.</p>

<p>El ejemplo m√°s sencillo es la arquitectura cliente-servidor, la m√°s popular en aplicaciones web sencillas: una m√°quina cliente y una m√°quina servidor ejecutan alternativamente fragmentos del c√≥digo, proporcionando al usuario final la sensaci√≥n de una aplicaci√≥n unificada.</p>

<p><img src="/assets/images/04-arquitectura-2-niveles.png" alt="Arquitectura en 2 niveles" /></p>

<p>Por supuesto, nada impide que tengamos m√°s de dos m√°quinas colaborando en red par ejecutar una aplicaci√≥n web. Podemos tener, por ejemplo, un cliente, un servidor web y un servidor de bases de datos (estos dos √∫ltimos en dos m√°quinas f√≠sicas diferentes). Esto ser√≠a una arquitectura de 3 niveles f√≠sicos.</p>

<p>La arquitectura de N niveles tendr√≠a este aspecto:</p>

<p><img src="/assets/images/04-arquitectura-N-niveles.png" alt="Arquitectura en N niveles" /></p>

<h2 id="42-arquitecturas-l√≥gicas-multicapa-multilayer">4.2 Arquitecturas L√ìGICAS multicapa (multilayer)</h2>

<p>Ahora viene la vuelta de tuerca: la arquitectura de una aplicaci√≥n tambi√©n puede referirse a sus capas (layers) l√≥gicas. Es decir, a las capas de software que nosotros, como desarrolladores, crearemos.</p>

<p>Dividir una aplicaci√≥n en capas que colaboran entre s√≠ por medio de interfaces bien definidos no es una idea nueva, ni pertenece exclusivamente al √°mbito de la programaci√≥n web. Pero la mayor parte de las aplicaciones web hacen uso de este mecanismo de abstracci√≥n.</p>

<p>La idea es dividir nuestra aplicaci√≥n en capas de niveles de abstracci√≥n cada vez mayor. La capa superior (la m√°s abstracta) es la que interacciona con el usuario: ah√≠ se implementar√° nuestro interfaz de usuario, o lo que en aplicaciones web se llama <em>front-end</em>.</p>

<p>La capa inferior (la menos abstracta) es la que est√° en contacto con el hardware de la m√°quina. Bueno, con el hardware no: debajo de ella habr√° otras capas que ya no pertenecen a nuestra aplicaci√≥n y que se encargar√°n de ello: el sistema operativo, el servidor, el gestor de bases de datos, o lo que sea. Pero nuestra capa inferior ser√° la que interact√∫e con esas otras capas que escapan a nuestros dominios y que est√°n en contacto con la m√°quina.</p>

<p>Esta divisi√≥n en capas de abstracci√≥n, que puede parecer al ne√≥fito una complicaci√≥n innecesaria, tiene un mont√≥n de ventajas y por eso se usa en cualquier aplicaci√≥n un poco m√°s complicada que ‚ÄúHola, mundo‚Äù.</p>

<h3 id="421-ventajas-de-las-arquitecturas-multicapa">4.2.1. Ventajas de las arquitecturas multicapa</h3>

<p>Las arquitecturas multicapa permiten varias cosas que no pueden hacerse con los c√≥digos monol√≠ticos. Entre otras:</p>

<ul>
  <li>Desarrollar en paralelo cada capa (mayor rapidez de desarrollo).</li>
  <li>Aplicaciones m√°s robustas (gracias al encapsulamiento. ¬øTe suena? ¬°Programaci√≥n orientada a objetos!).</li>
  <li>Matenimiento m√°s sencillo.</li>
  <li>M√°s flexibilidad para a√±adir m√≥dulos.</li>
  <li>M√°s escalabilidad para aumentar rendimiento.</li>
  <li>M√°s seguridad, al poder aislar (relativamente) cada capa del resto.</li>
  <li>Mejor escalabilidad: es m√°s f√°cil hacer crecer al sistema.</li>
  <li>Mejor rendimiento (aunque esto podr√≠a discutirse: puedes hacer un sistema multicapa con un rendimiento desastroso y un sistema monol√≠tico que vaya como un tiro. Pero, en general, es m√°s f√°cil mejorar el rendimiento trabajando en cada capa por separado).</li>
  <li>Es m√°s f√°cil hacer el control de calidad, incluyendo la fase de pruebas.</li>
</ul>

<h3 id="422-esquema-modelo-vista-controlador-mvc">4.2.2. Esquema Modelo-Vista-Controlador (MVC)</h3>

<p>Y por fin llegamos a la palabreja: Modelo-Vista-Controlador o MVC. ¬øQu√© narices es esto?</p>

<p>Tan solo una arquitectura multicapa estandarizada. Una arquitectura de 3 capas, para ser exactos.</p>

<p>Este es el esquema de una arquitectura en 3 capas. Recuerda: cada capa ejecuta una parte de la soluci√≥n, y entre ellas colaboran para formar la aplicaci√≥n completa. La capa superior interact√∫a con el usuario; la capa inferior, con la m√°quina (donde dice ‚Äúhardware‚Äù, deber√≠a decir ‚Äúcualquier cosa menos abstracta que nuestro programa‚Äù). Tienes permiso para imaginar cada capa como una clase con sus m√©todos y atributos.</p>

<p><img src="/assets/images/04-arquitectura-3-capas.png" alt="Arquitectura en 3 capas" /></p>

<p>Pues bien, si a esas tres les ponemos nombres ex√≥ticos como modelo, vista y controlador, y remeneamos un poco el esquema, ya lo tenemos: la arquitectura MVC.</p>

<p><img src="/assets/images/04-arquitectura-mvc.png" alt="Arquitectura MVC" /></p>

<p>Es decir, la arquitectura MVC solo es un caso particular de la arquitectura en 3 capas.</p>

<p>¬øY ya est√°? Bueno, no. Ahora tienes que aprender qu√© signfica <em>en realidad</em> esta palabrer√≠a.</p>

<p>Para que tengas una idea completa del asunto, ahora tienes que aprender qu√© parte de la aplicaci√≥n se ejecuta en cada una de las capas. Pero es m√°s simple de lo que parece. Y lo maravilloso es que el 99,99% de las aplicaciones web encajan como un guante en esta arquitectura. Es decir, apenas tendremos que hacer trabajo de dise√±o previo, porque, si es una aplicaci√≥n web, ya sabemos qu√© clases tendremos que construir: los que nos indique la arquitectura MVC.</p>

<p>Antes de entrar en profundidad, un breve apunte: por supuesto, nada impide construir arquitecturas con m√°s de 3 capas. De hecho, nosotros vamos a usar una variante del MVC en el que se a√±ade una capa adicional por debajo del modelo, es decir, una arquitectura con 4 capas. Pero ya llegaremos a eso.</p>

<h2 id="43-patrones-de-software">4.3. Patrones de software</h2>

<p>Los <strong>patrones de software</strong> son soluciones comprobadas a problemas comunes en el desarrollo de software.</p>

<p>Para que un patr√≥n pueda considerarse tal cosa, tiene que cumplir estas condiciones:</p>

<ul>
  <li>Debe haber sido comprobado en otros sistemas.</li>
  <li>Debe ser f√°cilmente reutilizable.</li>
  <li>Debe ser aplicable a diferentes circunstancias.</li>
  <li>Debe estar bien documentado.</li>
</ul>

<p>La documentaci√≥n t√≠pica de un patr√≥n de software incluye:</p>

<ul>
  <li>Problema que resuelve.</li>
  <li>Contexto en el que es aplicable.</li>
  <li>Fuerzas, objetivos y restricciones.</li>
  <li>Soluci√≥n que propone.</li>
  <li>Ejemplos.</li>
  <li>Contexto resultante.</li>
  <li>Exposici√≥n razonada.</li>
  <li>Otros patrones relacionados.</li>
</ul>

<h3 id="442-tipos-de-patrones">4.4.2. Tipos de patrones:</h3>

<p>Dependiendo del grado de abstracci√≥n del patr√≥n, existen patrones de diverso tipo:</p>

<ul>
  <li>De arquitectura</li>
  <li>De dise√±o</li>
  <li>De creaci√≥n de objetos</li>
  <li>De estructura de clases</li>
  <li>De comportamiento</li>
  <li>De dialectos</li>
  <li>De interacci√≥n o interfaz de usuario</li>
  <li>De an√°lisis</li>
  <li>De dominio</li>
</ul>

<p>Quiz√° no te sorprenda o√≠r que el esquema MVC se considera un <strong>patr√≥n de software de arquitectura</strong>.</p>

<h3 id="443-ejemplo-de-patr√≥n-el-patr√≥n-singleton">4.4.3. Ejemplo de patr√≥n: el patr√≥n Singleton</h3>

<p>Antes de centrarnos en MVC, vamos a ver, solo a modo de ejemplo, otro tipo de patr√≥n: <strong>el patr√≥n Singleton</strong>.</p>

<p>Algunos recursos en una aplicaci√≥n son de tal naturaleza que s√≥lo puede existir una instancia de ese tipo de recurso. Por ejemplo, la conexi√≥n a la base de datos a trav√©s de un manejador de base de datos. A veces interesa compartir un manejador de base de datos para que el resto de recursos no tengan que conectarse y desconectarse continuamente de la BD, y s√≥lo deber√≠a existir una instancia de ese manejador.</p>

<p>El patr√≥n Singleton cubre esta necesidad. Un objeto es ‚Äúsingleton‚Äù si la aplicaci√≥n puede generar una y s√≥lo una instancia del mismo.</p>

<p>Esta es una implementaci√≥n reutilizable de ese patr√≥n:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span><span class="p">(</span><span class="s2">"DB.php"</span><span class="p">);</span>

<span class="kd">class</span> <span class="nc">DatabaseConnection</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">get</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">static</span> <span class="nv">$db</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$db</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span>
      <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatabaseConnection</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$db</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">private</span> <span class="nv">$_handle</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$dsn</span> <span class="o">=</span> <span class="s1">'mysql://root:password@localhost/photos'</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_handle</span> <span class="o">=&amp;</span> <span class="no">DB</span><span class="o">::</span><span class="nf">Connect</span><span class="p">(</span> <span class="nv">$dsn</span><span class="p">,</span> <span class="k">array</span><span class="p">()</span> <span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">public</span> <span class="k">function</span> <span class="n">handle</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_handle</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">print</span><span class="p">(</span> <span class="s2">"Handle = "</span><span class="mf">.</span><span class="nc">DatabaseConnection</span><span class="o">::</span><span class="nf">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">handle</span><span class="p">()</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">);</span>
<span class="k">print</span><span class="p">(</span> <span class="s2">"Handle = "</span><span class="mf">.</span><span class="nc">DatabaseConnection</span><span class="o">::</span><span class="nf">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">handle</span><span class="p">()</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h2 id="45-el-patr√≥n-mvc-en-la-pr√°ctica">4.5. El patr√≥n MVC en la pr√°ctica</h2>

<p>Tras esta introducci√≥n, vamos a estudiar a fondo el patr√≥n MVC. Y lo vamos a hacer por medio de un ejemplo, que es como mejor suelen comprenderse estas cosas. Una vez terminado y comprendido el ejemplo, daremos una definici√≥n forma del patr√≥n MVC.</p>

<p>Si lees el c√≥digo fuente con atenci√≥n, ver√°s como, al acabar, entender√°s perfectamente en qu√© consiste el MVC y podr√°s empezar a aplicarlo en tus proyectos.</p>

<p>El ejemplo con el que vamos a trabajar es este: supongamos que queremos programar una peque√±a aplicaci√≥n web que nos permita hacer publicaciones en una especie de blog simplificado. Esas publicaciones se guardan como registros en una tabla de una base de datos.</p>

<p>En el c√≥digo de ejemplo sobre el que vamos a trabajar, nos vamos a centrar en obtener de la base de datos el listado de los art√≠culos existentes para mostrarlo en una p√°gina HTML.</p>

<h3 id="451-c√≥digo-monol√≠tico">4.5.1. C√≥digo monol√≠tico</h3>

<p>Una primera aproximaci√≥n a la soluci√≥n, sin usar ning√∫n patr√≥n de arquitectura en absoluto, podr√≠a ser esta (√©chale un vistazo y aseg√∫rate de entenderlo):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?</span>
  <span class="c1">// Conectamos con la base de datos</span>
  <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="s1">'host'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span> <span class="s1">'dbname'</span><span class="p">);</span>
  <span class="c1">// Lanzamos una consulta para recuperar los datos que necesitamos</span>
  <span class="nv">$resultado</span><span class="o">=</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
// Generamos una tabla con el resultado de la consulta
<span class="nt">&lt;h1&gt;</span>Listado de Art√≠culos<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;table&gt;</span>
     <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Fecha<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Titulo<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span>
  <span class="c1">// Recorremos fila a fila el resultado de la consulta</span>
  <span class="k">while</span> <span class="p">(</span><span class="nv">$fila</span> <span class="o">=</span> <span class="nv">$resultado</span><span class="o">-&gt;</span><span class="nf">fetch_array</span><span class="p">())</span>  <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">"&lt;tr&gt;"</span><span class="p">;</span>
      <span class="k">echo</span> <span class="s2">"&lt;td&gt; "</span><span class="mf">.</span><span class="nv">$fila</span><span class="p">[</span><span class="s1">'fecha'</span><span class="p">]</span><span class="mf">.</span><span class="s2">" &lt;/td&gt;"</span><span class="p">;</span>
      <span class="k">echo</span> <span class="s2">"&lt;td&gt; "</span><span class="mf">.</span><span class="nv">$fila</span><span class="p">[</span><span class="s1">'titulo'</span><span class="p">]</span><span class="mf">.</span><span class="s2">" &lt;/td&gt;"</span><span class="p">;</span>
      <span class="k">echo</span> <span class="s2">"&lt;/tr&gt;"</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">echo</span> <span class="s2">"&lt;/table&gt;"</span><span class="p">;</span>
  <span class="c1">// Cerramos la conexi√≥n con la BD</span>
  <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Esta soluci√≥n se denomina <strong>monol√≠tica</strong>, porque incluye todo el c√≥digo necesario en el mismo bloque. Por supuesto, para un ejemplo tan simple como este, el c√≥digo monol√≠tico es m√°s que suficiente, pero en un sistema m√°s complejo pronto empieza a convertirse en un monstruo inmanejable.</p>

<h3 id="452-primera-mejora-controlador--vista">4.5.2. Primera mejora: controlador + vista</h3>

<p>Vamos a aproximarnos un poco a la soluci√≥n MVC separando ese c√≥digo monol√≠tico en dos bloques (que guardaremos en archivos distintos):</p>

<ul>
  <li>Un controlador.</li>
  <li>Una vista.</li>
</ul>

<p>Primero, el <strong>controlador</strong>. Se encargar√° de recuperar los datos, pero <em>no de mostrarlos</em>. Generar el interfaz de usuario, es decir, el HTML, ser√° la labor que le dejaremos a la vista. El controlador preparar√° esos datos y los empaquetar√° en un array para que est√©n disponibles en la vista. Y la vista la insertaremos en el controlador con un include().</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?</span>
  <span class="c1">// Este es el controlador (esta aplicaci√≥n solo realiza una acci√≥n)</span>

  <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span> <span class="s1">'dbname'</span><span class="p">);</span>
  <span class="nv">$resultado</span><span class="o">=</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>

  <span class="nv">$articulos</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="nv">$fila</span> <span class="o">=</span> <span class="nv">$resultado</span><span class="o">-&gt;</span><span class="nf">fetch_array</span><span class="p">())</span>  <span class="p">{</span>
      <span class="nv">$articulos</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$fila</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>

  <span class="k">include</span><span class="p">(</span><span class="s1">'vista.php'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>La <strong>vista</strong> que mostrar√° los datos del array contiene un c√≥digo muy semejante al de la soluci√≥n monol√≠tica, solo que ahora estar√° ubicada en un archivo aparte, llamado vista.php, y har√° un bucle sobre el array de resultados que le ha preparado el controlador:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Listado de Articulos<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;table&gt;</span>
     <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Fecha<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Titulo<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span><span class="p">(</span><span class="nv">$articulos</span> <span class="k">as</span> <span class="nv">$articulo</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$articulo</span><span class="p">[</span><span class="s1">'fecha'</span><span class="p">]</span><span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$articulo</span><span class="p">[</span><span class="s1">'titulo'</span><span class="p">]</span><span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span><span class="cp">?&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre></div></div>

<h3 id="453-segunda-mejora-modelo-vista-y-controlador">4.5.3. Segunda mejora: modelo, vista y controlador</h3>

<p>En esta segunda mejora, dividiremos el c√≥digo en tres bloques (ubicados, de nuevo, en archivos diferentes):</p>

<ul>
  <li>Un modelo (archivo model.php) ‚Äì&gt; Contendr√° una clase con un m√©todo que se encargar√° de acceder a la base de datos y empaquetar el resultado de la consulta en un array.</li>
  <li>Una vista (archivo view.php) ‚Äì&gt; Se encargar√° de generar el HTML con el resultado de la consulta.</li>
  <li>Un controlador (archivo index.php) ‚Äì&gt; Se encargar√° de invocar al modelo y a la vista en el orden correcto.</li>
</ul>

<p>Por lo tanto, el <strong>controlador</strong> se queda en algo tan sencillo como esto:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span><span class="p">(</span><span class="s1">'model.php'</span><span class="p">);</span>	  <span class="c1">// En este archivo estar√° el modelo</span>
<span class="nv">$articulos</span> <span class="o">=</span> <span class="nc">Model</span><span class="o">::</span><span class="nf">getAll</span><span class="p">();</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'view.php'</span><span class="p">);</span>		<span class="c1">// En este archivo estar√° la vista</span>
</code></pre></div></div>

<p>El <strong>modelo</strong> consta de una clase con un m√©todo (de momento) encargado de consultar todos los art√≠culos y devolverlos empaquetados en un array:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">Model</span> <span class="p">{</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">getAll</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span> <span class="s1">'dbname'</span><span class="p">);</span>
    <span class="nv">$resultado</span><span class="o">=</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>

    <span class="nv">$articulos</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$fila</span> <span class="o">=</span> <span class="nv">$resultado</span><span class="o">-&gt;</span><span class="nf">fetch_array</span><span class="p">())</span>  <span class="p">{</span>
        <span class="nv">$articulos</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$fila</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>

    <span class="k">return</span> <span class="nv">$articulos</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Por √∫ltimo, la <strong>vista</strong> ser√° exactamente igual que en la versi√≥n anterior: un recorrido por el array de art√≠culos para mostrarlos en formato HTML:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Listado de Articulos<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;table&gt;</span>
     <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Fecha<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Titulo<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span><span class="p">(</span><span class="nv">$articulos</span> <span class="k">as</span> <span class="nv">$articulo</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$articulo</span><span class="p">[</span><span class="s1">'fecha'</span><span class="p">]</span><span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$articulo</span><span class="p">[</span><span class="s1">'titulo'</span><span class="p">]</span><span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span><span class="cp">?&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre></div></div>

<h3 id="454-tercera-mejora-a√±adiendo-capa-de-abstracci√≥n-de-datos">4.5.4. Tercera mejora: a√±adiendo capa de abstracci√≥n de datos</h3>

<p>Como no sabemos lo que es el miedo, vamos a complicar nuestro patr√≥n modelo-vista-controlador con una cuarta capa: la capa de abstracci√≥n de datos.</p>

<p>La idea de esta capa adicional es proporcionar un mecanismo de abstracci√≥n respecto del gestor de base de datos concreto que estemos utilizando.</p>

<p>Si te fijas en el <strong>modelo</strong> de la soluci√≥n anterior, ver√°s que estamos usando una clase (mysqli) y unos m√©todos que solo funcionan con MySQL o MariaDB. Si quis√©ramos cambiar el gestor de base de datos, tendr√≠amos que revisar todos nuestros modelos.</p>

<p>Una forma de independizar la aplicaci√≥n del gestor de base de datos es programar una <strong>capa de abstracci√≥n</strong> que contenga dos o tres m√©todos gen√©ricos (como consultar() para lanzar SELECT o manipular() para lanzar INSERT, UPDATE o DELETE).</p>

<p>De ese modo, cuando queramos hacer una consulta desde el modelo, no lo haremos con los m√©todos de MySQL o de otro gestor de bases de datos,  que traduzcan una petici√≥n gen√©rica (como consultar(‚ÄúSELECT * FROM users‚Äù)) a una petici√≥n concreta para un gestor de base de datos (new mysqli(‚Ä¶), $db-&gt;query(), etc).</p>

<p>Por lo tanto, en esta tercera mejor vamos a dividir el c√≥digo en cuatro bloques:</p>

<ul>
  <li>Un controlador (archivo index.php).</li>
  <li>Una vista (archivo view.php).</li>
  <li>Un modelo en dos capas
    <ul>
      <li>Capa de abstracci√≥n de datos (dbabstract.php)</li>
      <li>Capa de acceso a datos (el modelo propiamente dicho) (model.php).</li>
    </ul>
  </li>
</ul>

<p>El c√≥digo de la <strong>capa de abstracci√≥n</strong> ser√≠a algo as√≠:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">DbAbstract</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nv">$db</span><span class="p">;</span>
  <span class="k">function</span> <span class="n">crearConexion</span><span class="p">(</span><span class="nv">$servidor</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="nv">$servidor</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">cerrarConexion</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$db</span><span class="p">)</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">consulta</span><span class="p">(</span><span class="nv">$consulta</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$db</span><span class="err">‚Üí</span><span class="nf">query</span><span class="p">(</span><span class="nv">$consulta</span><span class="p">);</span>
    <span class="nv">$resArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$resArray</span> <span class="o">=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="nf">fetch_all</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$resArray</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="mf">...</span><span class="n">etc</span><span class="mf">...</span> <span class="p">(</span><span class="n">a√±adimos</span> <span class="n">cualquier</span> <span class="n">funci√≥n</span> <span class="n">que</span> <span class="n">acceda</span> <span class="n">directamente</span> <span class="n">a</span> <span class="nc">MySQL</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>El c√≥digo del <strong>modelo</strong> va a hacer uso de la capa de abstracci√≥n:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span> <span class="s2">"DbAbstract.php"</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Model</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">getAllArticulos</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">dbAbstract</span><span class="p">();</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">crearConexion</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span> <span class="s1">'dbName'</span><span class="p">);</span>
    <span class="nv">$articulos</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">consulta</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">cerrarConexion</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$articulos</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>El <strong>controlador</strong> y la <strong>vista</strong> son exactamente los mismos que en la soluci√≥n anterior.</p>

<h3 id="455-cuarta-y-√∫ltima-mejora-transformaci√≥n-en-clases-y-objetos-reutilizables">4.5.5. Cuarta (y √∫ltima) mejora: transformaci√≥n en clases y objetos reutilizables</h3>

<p>Para terminar, vamos a dejar el c√≥digo bien organizado y a mostrarlo completo.</p>

<p>Lo que haremos en esta √∫ltima etapa es empaquetarlo todo en clases reutilizables. Observa que sigue siendo el mismo c√≥digo fuente, solo que empaquetado en clases y m√©todos. Lo √∫nico que queda fuera de una clase es la instanciaci√≥n del objeto controlador.</p>

<p>F√≠jate bien en c√≥mo hemos convertido las vistas en una clase con un m√©todo show() que nos servir√° para mostrar cualquier vista y reutilizar el mismo header y el mismo foorter. Cada vista se programar√° en un archivo independiente que deberemos organizar el directorios y subdirectorios.</p>

<p>Otra cosa que quiero que observes con atenci√≥n es el controlador, porque lo hemos dejado preparado para poder a√±adir nuevas funciones al programa con posterioridad. Este controlador te servir√° de esqueleto para montar tus propias aplicaciones MVC.</p>

<p><strong>index.php</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$controlador</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Controller</span><span class="p">();</span>
<span class="nv">$controlador</span><span class="o">-&gt;</span><span class="nb">main</span><span class="p">();</span>
</code></pre></div></div>

<p><strong>controller.php</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span> <span class="p">(</span><span class="s2">"View.php"</span><span class="p">);</span>
<span class="k">include</span> <span class="p">(</span><span class="s2">"Model.php"</span><span class="p">);</span>

<span class="kd">class</span> <span class="nc">Controller</span> <span class="p">{</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$estado</span> <span class="o">=</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'do'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'do'</span><span class="p">]</span> <span class="p">;</span> <span class="s2">"formLogin"</span><span class="p">);</span>

      <span class="k">switch</span> <span class="p">(</span><span class="nv">$estado</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">case</span> <span class="s2">"formLogin"</span><span class="o">:</span> <span class="mf">...</span>
         <span class="k">case</span> <span class="s2">"checkLogin"</span><span class="o">:</span> <span class="mf">...</span>
         <span class="k">case</span> <span class="s2">"showAllArticles"</span><span class="o">:</span>
             <span class="nv">$articulos</span> <span class="o">=</span> <span class="nc">Articulos</span><span class="o">::</span><span class="nf">getAllArticulos</span><span class="p">();</span>
             <span class="nc">View</span><span class="o">::</span><span class="nf">show</span><span class="p">(</span><span class="s2">"showAllArticles"</span><span class="p">);</span>
             <span class="k">break</span><span class="p">;</span> 
         <span class="k">case</span> <span class="s2">"...etc..."</span><span class="o">:</span> <span class="mf">...</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>view.php</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">View</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">show</span><span class="p">(</span><span class="nv">$nombreVista</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">include</span><span class="p">(</span><span class="s2">"header.php"</span><span class="p">);</span>
      <span class="k">include</span><span class="p">(</span><span class="s2">"</span><span class="nv">$nombreVista</span><span class="s2">.php"</span><span class="p">);</span>
      <span class="k">include</span><span class="p">(</span><span class="s2">"footer.php"</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p><strong>showAllArticles.php</strong></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nt">&lt;h1&gt;</span>Listado de Articulos<span class="nt">&lt;/h1&gt;</span>
   <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>Fecha<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Titulo<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span>
   <span class="cp">&lt;?php foreach($articulos as $articulo): ?&gt;</span>
       <span class="nt">&lt;tr&gt;</span>
           <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php echo $articulo['fecha']?&gt;</span><span class="nt">&lt;/td&gt;</span>
           <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php echo $articulo['titulo']?&gt;</span><span class="nt">&lt;/td&gt;</span>
       <span class="nt">&lt;/tr&gt;</span>
   <span class="cp">&lt;?php endforeach;?&gt;</span>
   <span class="nt">&lt;/table&gt;</span>
   <span class="nt">&lt;</span><span class="err">?</span><span class="na">php</span>
    <span class="err">}</span>
<span class="err">}</span>
</code></pre></div></div>

<p><strong>model.php</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">include</span> <span class="s2">"dbabstract.php"</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Model</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">getAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">dbAbstract</span><span class="p">();</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">crearConexion</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'usuario'</span><span class="p">,</span> <span class="s1">'clave'</span><span class="p">,</span><span class="s1">'dbName'</span><span class="p">);</span>
    <span class="nv">$articulos</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">cosulta</span><span class="p">(</span><span class="s1">'SELECT fecha, titulo FROM articulo'</span><span class="p">);</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">cerrarConexion</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$articulos</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>dbabstract.php</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">DbAbstract</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nv">$db</span><span class="p">;</span>
  <span class="k">function</span> <span class="n">crearConexion</span><span class="p">(</span><span class="nv">$servidor</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="nv">$servidor</span><span class="p">,</span> <span class="nv">$usuario</span><span class="p">,</span> <span class="nv">$clave</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">cerrarConexion</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$db</span><span class="p">)</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="n">consulta</span><span class="p">(</span><span class="nv">$consulta</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$db</span><span class="err">‚Üí</span><span class="nf">query</span><span class="p">(</span><span class="nv">$consulta</span><span class="p">);</span>
    <span class="nv">$resArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$resArray</span> <span class="o">=</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="nf">fetch_all</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$resArray</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="mf">...</span><span class="n">etc</span><span class="mf">...</span> <span class="p">(</span><span class="n">a√±adimos</span> <span class="n">cualquier</span> <span class="n">funci√≥n</span> <span class="n">que</span> <span class="n">acceda</span> <span class="n">directamente</span> <span class="n">a</span> <span class="nc">MySQL</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="46-una-explicaci√≥n-del-patr√≥n-mvc">4.6. Una explicaci√≥n del patr√≥n MVC</h2>

<p>Ahora que hemos aprendido a manejarnos con el patr√≥n MVC por medio de un ejemplo, estamos en condiciones de definirlo de manera m√°s te√≥rica y, oh maravilla, incluso entender esa definici√≥n.</p>

<p>El patr√≥n MVC divide la aplicaci√≥n en tres capas:</p>

<ul>
  <li>
    <p><strong>Los modelos</strong>, donde se programa la <em>l√≥gica de negocio</em>. De esa forma tan rimbombante se refiere la literatura t√©cnica al acceso a los datos con los filtros, algoritmos y restricciones que el sistema imponga.</p>

    <p>En la pr√°ctica, esto significa que en los modelos debemos colocar todo el c√≥digo de acceso a la base de datos o a cualquier otro recurso del servidor (como las variables de sesi√≥n, por ejemplo). Los modelos deben empaquetarlos en objetos est√°ndar de PHP (como arrays) y devolverlos al controlador.</p>

    <p>Lo m√°s pr√°ctico es crear un modelo para cada tabla maestra de la base de datos.</p>

    <p>Los frameworks automatizan los m√©todos m√°s t√≠picos de cada modelo, como insertar un registro, borrar, actualizar, consultar uno o consultar todos.</p>
  </li>
  <li>
    <p><strong>Las vistas</strong>, donde se programan todas las salidas HTML que el usuario final va a ver y con las que va a interactuar.</p>

    <p>El c√≥digo Javascript y CSS, por lo tanto, forma parte de las vistas.</p>

    <p>En las vistas estar√° el grueso del c√≥digo de cualquier aplicaci√≥n. Los frameworks m√°s avanzados incluyen sistemas de plantillas y lenguajes adicionales para simplificar este proceso, pero si programamos en PHP cl√°sico, tendremos que construir las vistas manualmente.</p>
  </li>
  <li>
    <p><strong>Los controladores</strong>, donde se captura cada petici√≥n del usuario y se dirige el flujo de ejecuci√≥n, invocando a los modelos y a las vistas en el orden adecuado.</p>

    <p>En una aplicaci√≥n peque√±a, bastar√° con tener un controlador para todo. Cuando la aplicaci√≥n crece, suele hacerse un controlador por cada modelo, es decir, un controlador por cada tabla maestra.</p>

    <p>Nuestros controladores van a estar compuestos por un switch muy grande con un case para cada funcionalidad de la aplicaci√≥n. Ese switch estar√° dirigido por una variable de control. En los frameworks, este switch se transforma en una colecci√≥n de m√©todos, lo cual proporciona un c√≥digo mucho m√°s elegante, pero que funcionalmente hace lo mismo.</p>
  </li>
</ul>

:ET